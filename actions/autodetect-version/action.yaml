# This workflow tries to automatically generate current app version
# It uses two sources of truth:
#   * GitHub Workflow Action context;
#   * Current git repository state (see 'git describe');
#
# The action does not mutate any files in repository or affect application builds.
# It only sets 'output.version' the user can then pass to another workflows.

name: Autodetect application version
description: |
  Automatically detect version number from current Action context or
  generate the new one from git repository state (see 'git describe')

inputs:
  fetch-depth:
    description: 'The number of commits of git history from current HEAD to fetch'
    required: false
    default: '100'

outputs:
  version:
    description: 'Automatically detected (generated) version number'
    value: ${{ toJSON(steps.version-generator) }}

runs:
  using: "composite"

  steps:
    - uses: actions/checkout@v2

    - id: version-generator
      run: ${{ github.action_path }}/detect-version.sh ${{ inputs.fetch-depth }}
      shell: bash
      env:
        CONTEXT_GITHUB: ${{ toJSON(github) }}
