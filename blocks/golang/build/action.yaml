name: Build Golang project
author: 'MiLaboratories'
description: |
  Build Golang project.

  Prepare agent for building a Golang project.
  Install Golang specific version, cache dependencies, re-use build results
  uploading selected build results into GitHub Actions artifacts storage.

inputs:
  bootstrap-ci-script-name:
    description: |
      Bootstrap CI script name (install go modules, C++ libraries, binary tools, etc)
    required: true
    default: 'bootstrap-ci.sh'

  golang-version:
    description: |
      Golang version to use.
      Examples: '1.19', '1.20'
    required: true

  cache-version:
    description: |
      Simple hack, that allows to 'reset' cache for particular job.

      Just change the value of this parameter and the next run will
      not find build cache and will have to start from scratch.

    required: false
    default: 'v1'

runs:
  using: "composite"

  steps:
    - name: Prepare environment for building a Golang application
      uses:  milaboratory/github-ci/actions/golang/prepare@v4-beta
      with:
        golang-version: ${{ inputs.golang-version }}
        cache-version: ${{ inputs.cache-version }}

    - name: Setup git credentials to access private go modules
      uses: milaboratory/github-ci/actions/shell@v4-beta
      env:
        GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        run: |
          git config --global user.email "ci@milaboratories.com"
          git config --global user.name "MiLab CI/CD Robot"
          git config --global url."https://${GIT_TOKEN}@github.com/".insteadOf https://github.com/

    - name: Run golang project ci bootstrap script
      uses: milaboratory/github-ci/actions/shell@v4-beta
      env:
        CI_SCRIPT: ${{ inputs.bootstrap-ci-script-name }}
      with:
        run: |
           if [ -x "${CI_SCRIPT}" ];then
             "./${CI_SCRIPT}"
           else
             printf "File: %s doesn't exist or it's not executable." "${CI_SCRIPT}"
           fi


